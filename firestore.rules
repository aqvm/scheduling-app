rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function membershipDocId(campaignId, uid) {
      return campaignId + '_' + uid;
    }

    function userDocPath(appNamespace, uid) {
      return /databases/$(database)/documents/apps/$(appNamespace)/users/$(uid);
    }

    function hasUserProfile(appNamespace, uid) {
      return signedIn() &&
        exists(userDocPath(appNamespace, uid));
    }

    function hasRole(appNamespace, uid, role) {
      return hasUserProfile(appNamespace, uid) &&
        get(userDocPath(appNamespace, uid)).data.role == role;
    }

    function isAdmin(appNamespace, uid) {
      return hasRole(appNamespace, uid, 'admin');
    }

    function isCampaignMember(appNamespace, campaignId, uid) {
      return signedIn() &&
        exists(/databases/$(database)/documents/apps/$(appNamespace)/memberships/$(membershipDocId(campaignId, uid)));
    }

    function hasValidAvailabilityPayload() {
      return request.resource.data.days is map &&
        request.resource.data.days.keys().size() <= 366 &&
        request.resource.data.days.values().hasOnly(['unspecified', 'available', 'maybe', 'unavailable']);
    }

    function isMembershipIdForUid(membershipId, uid) {
      return membershipId.matches('^.+_' + uid + '$');
    }

    function hasValidAlias(alias) {
      return alias is string &&
        alias.size() > 0 &&
        alias.size() <= 64;
    }

    function hasValidNameChangeRequestStatus(status) {
      return status == 'pending' || status == 'approved' || status == 'rejected';
    }

    function nameChangeRequestPath(appNamespace, membershipId) {
      return /databases/$(database)/documents/apps/$(appNamespace)/nameChangeRequests/$(membershipId);
    }

    function canAdminApplyApprovedNameChange(appNamespace, membershipId, nextData) {
      return existsAfter(nameChangeRequestPath(appNamespace, membershipId)) &&
        getAfter(nameChangeRequestPath(appNamespace, membershipId)).data.status == 'approved' &&
        getAfter(nameChangeRequestPath(appNamespace, membershipId)).data.uid == nextData.uid &&
        getAfter(nameChangeRequestPath(appNamespace, membershipId)).data.campaignId == nextData.campaignId &&
        getAfter(nameChangeRequestPath(appNamespace, membershipId)).data.requestedAlias == nextData.alias &&
        getAfter(nameChangeRequestPath(appNamespace, membershipId)).data.reviewedByUid == request.auth.uid;
    }

    function hasImmutableMembershipAlias(existingData, nextData) {
      return (
        existingData.alias is string &&
        existingData.alias.size() > 0 &&
        existingData.alias.size() <= 64
      )
        ? nextData.alias == existingData.alias
        : hasValidAlias(nextData.alias);
    }

    match /apps/{appNamespace}/users/{userId} {
      allow get: if signedIn() &&
        (
          request.auth.uid == userId ||
          isAdmin(appNamespace, request.auth.uid)
        );

      allow list: if signedIn() && isAdmin(appNamespace, request.auth.uid);

      allow create: if signedIn() &&
        request.auth.uid == userId &&
        request.resource.data.keys().hasOnly(['alias', 'role', 'createdAt', 'lastSeenAt']) &&
        hasValidAlias(request.resource.data.alias) &&
        request.resource.data.role == 'member' &&
        request.resource.data.lastSeenAt is timestamp &&
        request.resource.data.createdAt is timestamp;

      allow update: if signedIn() &&
        request.auth.uid == userId &&
        request.resource.data.keys().hasOnly(['alias', 'role', 'createdAt', 'lastSeenAt']) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['alias', 'lastSeenAt']) &&
        hasValidAlias(request.resource.data.alias) &&
        request.resource.data.lastSeenAt is timestamp &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if false;
    }

    match /apps/{appNamespace}/campaigns/{campaignId} {
      allow read: if signedIn() &&
        (isAdmin(appNamespace, request.auth.uid) || isCampaignMember(appNamespace, campaignId, request.auth.uid));

      allow create: if signedIn() &&
        isAdmin(appNamespace, request.auth.uid) &&
        request.resource.data.keys().hasOnly(['name', 'inviteCode', 'inviteEnabled', 'createdByUid', 'createdAt', 'updatedAt']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 64 &&
        request.resource.data.inviteCode is string &&
        request.resource.data.inviteCode.size() >= 8 &&
        request.resource.data.inviteCode.size() <= 32 &&
        request.resource.data.inviteEnabled == true &&
        request.resource.data.createdByUid == request.auth.uid &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;

      allow update: if signedIn() &&
        isAdmin(appNamespace, request.auth.uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['inviteEnabled', 'updatedAt']) &&
        request.resource.data.inviteEnabled is bool &&
        request.resource.data.updatedAt is timestamp &&
        request.resource.data.name == resource.data.name &&
        request.resource.data.inviteCode == resource.data.inviteCode &&
        request.resource.data.createdByUid == resource.data.createdByUid &&
        request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if signedIn() && isAdmin(appNamespace, request.auth.uid);
    }

    match /apps/{appNamespace}/campaignInvites/{inviteCode} {
      allow get: if signedIn();
      allow list: if signedIn() && isAdmin(appNamespace, request.auth.uid);

      allow create: if signedIn() &&
        isAdmin(appNamespace, request.auth.uid) &&
        inviteCode.size() >= 8 &&
        inviteCode.size() <= 32 &&
        request.resource.data.keys().hasOnly(['campaignId', 'enabled', 'createdByUid', 'createdAt', 'updatedAt']) &&
        request.resource.data.campaignId is string &&
        request.resource.data.campaignId.size() > 0 &&
        request.resource.data.enabled == true &&
        request.resource.data.createdByUid == request.auth.uid &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;

      allow update: if signedIn() &&
        isAdmin(appNamespace, request.auth.uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['enabled', 'updatedAt']) &&
        request.resource.data.enabled is bool &&
        request.resource.data.updatedAt is timestamp &&
        request.resource.data.campaignId == resource.data.campaignId &&
        request.resource.data.createdByUid == resource.data.createdByUid &&
        request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if signedIn() && isAdmin(appNamespace, request.auth.uid);
    }

    match /apps/{appNamespace}/nameChangeRequests/{requestId} {
      allow get: if signedIn() &&
        (
          isAdmin(appNamespace, request.auth.uid) ||
          (
            resource != null &&
            resource.data.uid == request.auth.uid
          ) ||
          (
            resource == null &&
            isMembershipIdForUid(requestId, request.auth.uid)
          )
        );

      allow list: if signedIn() && isAdmin(appNamespace, request.auth.uid);

      allow create: if signedIn() &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'requestedAlias', 'status', 'createdByUid', 'reviewedByUid', 'createdAt', 'updatedAt']) &&
        request.resource.data.campaignId is string &&
        request.resource.data.campaignId.size() > 0 &&
        request.resource.data.uid == request.auth.uid &&
        requestId == membershipDocId(request.resource.data.campaignId, request.auth.uid) &&
        isCampaignMember(appNamespace, request.resource.data.campaignId, request.auth.uid) &&
        hasValidAlias(request.resource.data.requestedAlias) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.createdByUid == request.auth.uid &&
        request.resource.data.reviewedByUid == '' &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;

      allow update: if signedIn() &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'requestedAlias', 'status', 'createdByUid', 'reviewedByUid', 'createdAt', 'updatedAt']) &&
        requestId == membershipDocId(resource.data.campaignId, resource.data.uid) &&
        request.resource.data.campaignId == resource.data.campaignId &&
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.createdByUid == resource.data.createdByUid &&
        request.resource.data.createdAt == resource.data.createdAt &&
        hasValidAlias(request.resource.data.requestedAlias) &&
        hasValidNameChangeRequestStatus(request.resource.data.status) &&
        request.resource.data.updatedAt is timestamp &&
        (
          (
            request.auth.uid == resource.data.uid &&
            request.resource.data.status == 'pending' &&
            request.resource.data.reviewedByUid == '' &&
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['requestedAlias', 'status', 'reviewedByUid', 'updatedAt'])
          ) ||
          (
            isAdmin(appNamespace, request.auth.uid) &&
            request.resource.data.requestedAlias == resource.data.requestedAlias &&
            (request.resource.data.status == 'approved' || request.resource.data.status == 'rejected') &&
            request.resource.data.reviewedByUid == request.auth.uid &&
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'reviewedByUid', 'updatedAt'])
          )
        );

      allow delete: if false;
    }

    match /apps/{appNamespace}/memberships/{membershipId} {
      allow get: if signedIn() &&
        (
          isAdmin(appNamespace, request.auth.uid) ||
          (
            resource != null &&
            (
              resource.data.uid == request.auth.uid ||
              isCampaignMember(appNamespace, resource.data.campaignId, request.auth.uid)
            )
          ) ||
          (
            resource == null &&
            isMembershipIdForUid(membershipId, request.auth.uid)
          )
        );

      allow list: if signedIn() &&
        (
          isAdmin(appNamespace, request.auth.uid) ||
          resource.data.uid == request.auth.uid ||
          isCampaignMember(appNamespace, resource.data.campaignId, request.auth.uid)
        );

      allow create: if signedIn() &&
        existsAfter(userDocPath(appNamespace, request.auth.uid)) &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'alias', 'joinedAt', 'lastSeenAt']) &&
        request.resource.data.campaignId is string &&
        request.resource.data.campaignId.size() > 0 &&
        request.resource.data.uid == request.auth.uid &&
        membershipId == membershipDocId(request.resource.data.campaignId, request.auth.uid) &&
        hasValidAlias(request.resource.data.alias) &&
        request.resource.data.joinedAt is timestamp &&
        request.resource.data.lastSeenAt is timestamp &&
        (
          isAdmin(appNamespace, request.auth.uid) ||
          (
            exists(/databases/$(database)/documents/apps/$(appNamespace)/campaigns/$(request.resource.data.campaignId)) &&
            get(/databases/$(database)/documents/apps/$(appNamespace)/campaigns/$(request.resource.data.campaignId)).data.inviteEnabled == true
          )
        );

      allow update: if signedIn() &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'alias', 'joinedAt', 'lastSeenAt']) &&
        membershipId == membershipDocId(resource.data.campaignId, resource.data.uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['alias', 'lastSeenAt']) &&
        request.resource.data.campaignId == resource.data.campaignId &&
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.joinedAt == resource.data.joinedAt &&
        request.resource.data.lastSeenAt is timestamp &&
        (
          (
            hasUserProfile(appNamespace, request.auth.uid) &&
            request.auth.uid == resource.data.uid &&
            hasImmutableMembershipAlias(resource.data, request.resource.data)
          ) ||
          (
            isAdmin(appNamespace, request.auth.uid) &&
            hasValidAlias(request.resource.data.alias) &&
            canAdminApplyApprovedNameChange(appNamespace, membershipId, request.resource.data)
          )
        );

      allow delete: if signedIn() && isAdmin(appNamespace, request.auth.uid);
    }

    match /apps/{appNamespace}/availability/{entryId} {
      allow read: if signedIn() &&
        (
          isAdmin(appNamespace, request.auth.uid) ||
          resource.data.uid == request.auth.uid ||
          isCampaignMember(appNamespace, resource.data.campaignId, request.auth.uid)
        );

      allow create: if signedIn() &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'days', 'updatedAt']) &&
        request.resource.data.campaignId is string &&
        request.resource.data.campaignId.size() > 0 &&
        request.resource.data.uid == request.auth.uid &&
        entryId == membershipDocId(request.resource.data.campaignId, request.auth.uid) &&
        exists(/databases/$(database)/documents/apps/$(appNamespace)/memberships/$(membershipDocId(request.resource.data.campaignId, request.auth.uid))) &&
        hasValidAvailabilityPayload() &&
        request.resource.data.updatedAt is timestamp;

      allow update: if signedIn() &&
        request.resource.data.keys().hasOnly(['campaignId', 'uid', 'days', 'updatedAt']) &&
        request.resource.data.campaignId == resource.data.campaignId &&
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.uid == request.auth.uid &&
        entryId == membershipDocId(resource.data.campaignId, resource.data.uid) &&
        exists(/databases/$(database)/documents/apps/$(appNamespace)/memberships/$(membershipDocId(resource.data.campaignId, request.auth.uid))) &&
        hasValidAvailabilityPayload() &&
        request.resource.data.updatedAt is timestamp;

      allow delete: if signedIn() &&
        (isAdmin(appNamespace, request.auth.uid) || resource.data.uid == request.auth.uid);
    }

    match /apps/{appNamespace}/campaignSettings/{campaignId} {
      allow read: if signedIn() &&
        (isAdmin(appNamespace, request.auth.uid) || isCampaignMember(appNamespace, campaignId, request.auth.uid));

      allow create, update: if signedIn() &&
        isAdmin(appNamespace, request.auth.uid) &&
        request.resource.data.keys().hasOnly(['hostUserId', 'updatedAt']) &&
        request.resource.data.hostUserId is string &&
        request.resource.data.hostUserId.size() <= 128 &&
        (
          request.resource.data.hostUserId == '' ||
          existsAfter(/databases/$(database)/documents/apps/$(appNamespace)/memberships/$(membershipDocId(campaignId, request.resource.data.hostUserId)))
        ) &&
        request.resource.data.updatedAt is timestamp;

      allow delete: if signedIn() && isAdmin(appNamespace, request.auth.uid);
    }
  }
}
